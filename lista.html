<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Usuarios</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* MANTIENE LOS MISMOS ESTILOS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 3rem; margin-bottom: 10px; }
        .title { font-size: 2rem; font-weight: 600; color: white; margin-bottom: 10px; }
        .subtitle { color: rgba(255, 255, 255, 0.8); font-size: 1.1rem; }
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .card-title { font-size: 1.5rem; font-weight: 600; color: #2d3748; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; }
        .btn-secondary:hover { background: #edf2f7; }
        .user-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .user-table th, .user-table td { padding: 15px 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .user-table th { font-weight: 600; color: #4a5568; background: #f8fafc; font-size: 0.9rem; }
        .user-table tr:hover { background: #f7fafc; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-pendiente { background: #fffaf0; color: #dd6b20; }
        .status-entregado { background: #f0fff4; color: #38a169; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-right: 5px; transition: all 0.2s ease; }
        .action-btn.entregado { background: #f0fff4; color: #38a169; border: 1px solid #c6f6d5; }
        .action-btn.entregado:hover { background: #c6f6d5; }
        .empty-state { text-align: center; padding: 60px 20px; color: #a0aec0; }
        .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #667eea; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #2d3748; display: block; }
        .stat-label { font-size: 0.8rem; color: #718096; font-weight: 500; }
        .nav-links { text-align: center; margin-top: 30px; }
        .loading { text-align: center; padding: 20px; color: #667eea; }
        @media (max-width: 768px) { .card-header { flex-direction: column; align-items: stretch; } .user-table { font-size: 0.8rem; } .user-table th, .user-table td { padding: 10px 8px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üë•</div>
            <h1 class="title">Lista de Usuarios</h1>
            <p class="subtitle">Gesti√≥n y control de registros</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Usuarios Registrados</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="cargarUsuarios()">
                        üîÑ Actualizar
                    </button>
                    <button class="btn btn-primary" onclick="descargarExcel()">
                        üìä Descargar Excel
                    </button>
                    <a href="registro.html" class="btn btn-secondary">
                        üìù Nuevo Registro
                    </a>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">Cargando usuarios...</div>

            <!-- Estad√≠sticas -->
            <div id="statsContainer"></div>

            <!-- Lista de usuarios -->
            <div id="listaUsuarios"></div>
        </div>

        <div class="nav-links">
            <a href="registro.html" class="btn btn-secondary">‚Üê Volver al Registro</a>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase (LA MISMA EN TODOS LOS ARCHIVOS)
        const firebaseConfig = {
            apiKey: "AIzaSyDXWCaRziv_QnmAmylZsWrroCyQjVRv3o0",
            authDomain: "sistema-registro-qr.firebaseapp.com",
            projectId: "sistema-registro-qr",
            storageBucket: "sistema-registro-qr.firebasestorage.app",
            messagingSenderId: "927176474405",
            appId: "1:927176474405:web:16002148918ebb34c924cc"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let usuarios = [];

        // Inicializar
        $(document).ready(function() {
            cargarUsuarios();
            
            // Verificar si hay par√°metros en la URL para actualizar estado
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('actualizar');
            
            if (userId) {
                actualizarEstadoUsuario(userId);
            }
        });

        // Cargar usuarios desde Firebase
        async function cargarUsuarios() {
            const loading = $('#loading');
            const listaUsuarios = $('#listaUsuarios');
            
            loading.show();
            listaUsuarios.html('');

            try {
                const snapshot = await db.collection('usuarios')
                    .orderBy('fechaRegistro', 'desc')
                    .get();
                
                usuarios = snapshot.docs.map(doc => doc.data());
                actualizarVista();
                
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al cargar usuarios: ' + error.message, 'error');
                mostrarVacia();
            } finally {
                loading.hide();
            }
        }

        // Actualizar estado del usuario
        async function actualizarEstadoUsuario(userId) {
            try {
                await db.collection('usuarios').doc(userId).update({
                    estatus: 'Entregado',
                    fechaActualizacion: new Date().toISOString()
                });
                
                mostrarNotificacion('‚úÖ Estado actualizado a: ENTREGADO', 'success');
                cargarUsuarios();
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al actualizar estado: ' + error.message, 'error');
            }
        }

        // El resto de las funciones (actualizarVista, mostrarVacia, etc.) se mantienen igual
        // Actualizar la vista
        function actualizarVista() {
            const container = $('#listaUsuarios');
            const statsContainer = $('#statsContainer');

            if (usuarios.length === 0) {
                statsContainer.html('');
                container.html(`
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <h3 style="color: #a0aec0; margin-bottom: 10px;">No hay usuarios registrados</h3>
                        <p style="color: #cbd5e0;">Comienza registrando el primer usuario</p>
                        <a href="registro.html" class="btn btn-primary" style="margin-top: 20px;">
                            üìù Registrar Primer Usuario
                        </a>
                    </div>
                `);
                return;
            }

            // Estad√≠sticas
            const total = usuarios.length;
            const entregados = usuarios.filter(u => u.estatus === 'Entregado').length;
            const pendientes = total - entregados;

            statsContainer.html(`
                <div class="stats-container">
                    <div class="stat-card">
                        <span class="stat-number">${total}</span>
                        <span class="stat-label">Total Registros</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" style="color: #38a169;">${entregados}</span>
                        <span class="stat-label">Entregados</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" style="color: #dd6b20;">${pendientes}</span>
                        <span class="stat-label">Pendientes</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" style="color: #667eea;">${Math.round((entregados/total)*100)}%</span>
                        <span class="stat-label">Tasa de Entrega</span>
                    </div>
                </div>
            `);

            // Tabla
            let html = `
                <div style="overflow-x: auto;">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Fecha Registro</th>
                                <th>√öltima Actualizaci√≥n</th>
                                <th>Estatus</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Ordenar por fecha m√°s reciente primero
            usuarios.sort((a, b) => new Date(b.fechaRegistro) - new Date(a.fechaRegistro));

            usuarios.forEach(usuario => {
                const fechaRegistro = new Date(usuario.fechaRegistro).toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const fechaActualizacion = new Date(usuario.fechaActualizacion).toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const statusClass = usuario.estatus === 'Pendiente' ? 'status-pendiente' : 'status-entregado';
                const statusText = usuario.estatus === 'Pendiente' ? 'Pendiente' : 'Entregado';
                
                html += `
                    <tr>
                        <td style="font-weight: 500;">${usuario.nombre}</td>
                        <td style="color: #718096; font-size: 0.9rem;">${fechaRegistro}</td>
                        <td style="color: #718096; font-size: 0.9rem;">${fechaActualizacion}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            ${usuario.Estatus === 'Pendiente' ? 
                                `<button class="action-btn entregado" onclick="marcarEntregado('${usuario.id}')" title="Marcar como entregado">
                                    ‚úÖ Entregado
                                </button>` : 
                                '<span style="color: #718096; font-size: 0.8rem;">Completado</span>'
                            }
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.html(html);
        }

        // Marcar como entregado manualmente
        async function marcarEntregado(userId) {
            if (confirm('¬øMarcar este registro como entregado?')) {
                await actualizarEstadoUsuario(userId);
            }
        }

        // Descargar Excel
        function descargarExcel() {
            if (usuarios.length === 0) {
                mostrarNotificacion('No hay datos para exportar', 'error');
                return;
            }

            const datos = [
                ['ID', 'Nombre Completo', 'Fecha Registro', 'Fecha Actualizaci√≥n', 'Estatus']
            ];

            usuarios.forEach(usuario => {
                datos.push([
                    usuario.id,
                    usuario.nombre,
                    new Date(usuario.fechaRegistro).toLocaleString('es-ES'),
                    new Date(usuario.fechaActualizacion).toLocaleString('es-ES'),
                    usuario.estatus
                ]);
            });

            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(datos);
            
            const colWidths = [
                { wch: 25 }, { wch: 35 }, { wch: 25 }, { wch: 25 }, { wch: 15 }
            ];
            worksheet['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Usuarios');
            XLSX.writeFile(workbook, `registro_usuarios_${new Date().toISOString().split('T')[0]}.xlsx`);
            mostrarNotificacion('Excel descargado exitosamente', 'success');
        }

        // Notificaci√≥n
        function mostrarNotificacion(mensaje, tipo) {
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                ${tipo === 'success' ? 'background: #38a169;' : 'background: #e53e3e;'}
            `;
            
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            setTimeout(() => notificacion.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notificacion.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(notificacion), 300);
            }, 3000);
        }
        // ... [copia las mismas funciones que ten√≠as antes para la vista]
    </script>
</body>
</html>