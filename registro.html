<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Usuarios</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* MANTIENE LOS MISMOS ESTILOS QUE TENÍAS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { max-width: 500px; width: 100%; }
        .card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; }
        .logo { font-size: 3rem; margin-bottom: 20px; }
        .title { font-size: 1.8rem; font-weight: 600; color: #2d3748; margin-bottom: 10px; }
        .subtitle { color: #718096; margin-bottom: 30px; font-size: 1rem; }
        .form-group { margin-bottom: 25px; text-align: left; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: #4a5568; font-size: 0.9rem; }
        .form-input { width: 100%; padding: 15px 20px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; }
        .form-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { padding: 15px 30px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; margin-top: 10px; }
        .btn-secondary:hover { background: #edf2f7; }
        .qr-section { margin-top: 30px; display: none; }
        .qr-container { display: inline-block; padding: 25px; background: white; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin: 20px 0; }
        .qr-title { font-size: 1.2rem; font-weight: 600; color: #2d3748; margin-bottom: 15px; }
        .qr-instructions { color: #718096; margin: 15px 0; font-size: 0.9rem; line-height: 1.5; }
        .nav-links { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
        .nav-link { display: inline-block; padding: 10px 20px; background: #f7fafc; color: #667eea; text-decoration: none; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; }
        .nav-link:hover { background: #667eea; color: white; }
        .loading { display: none; color: #667eea; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="logo">📝</div>
            <h1 class="title">Registro de Usuario</h1>
            <p class="subtitle">Completa los datos para generar el código QR</p>
            
            <div class="form-group">
                <label class="form-label">Nombre Completo</label>
                <input type="text" id="nombre" class="form-input" placeholder="Ingrese el nombre completo" required>
            </div>
            
            <div class="loading" id="loading">Registrando usuario...</div>
            
            <button class="btn btn-primary" onclick="registrarUsuario()" id="btnRegistrar">
                Registrar y Generar QR
            </button>

            <!-- Sección QR -->
            <div class="qr-section" id="qrSection">
                <div class="qr-title">🎯 QR Generado</div>
                <div class="qr-container">
                    <div id="qrcode"></div>
                </div>
                <p class="qr-instructions">
                    Escanea este código QR para marcar el registro como <strong>ENTREGADO</strong>
                </p>
                <button class="btn btn-secondary" onclick="descargarQR()">
                    📥 Descargar QR como Imagen
                </button>
            </div>

            <!-- <div class="nav-links">
                <a href="lista.html" class="nav-link">📋 Ver Lista de Usuarios</a>
            </div> -->
        </div>
    </div>

    <script>
        // Configuración de Firebase (LA MISMA EN TODOS LOS ARCHIVOS)
        const firebaseConfig = {
            apiKey: "AIzaSyDXWCaRziv_QnmAmylZsWrroCyQjVRv3o0",
            authDomain: "sistema-registro-qr.firebaseapp.com",
            projectId: "sistema-registro-qr",
            storageBucket: "sistema-registro-qr.firebasestorage.app",
            messagingSenderId: "927176474405",
            appId: "1:927176474405:web:16002148918ebb34c924cc"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Función para registrar usuario
        async function registrarUsuario() {
            const nombre = $('#nombre').val().trim();
            const btnRegistrar = $('#btnRegistrar');
            const loading = $('#loading');
            
            if (!nombre) {
                mostrarNotificacion('Por favor ingrese un nombre completo', 'error');
                return;
            }

            btnRegistrar.prop('disabled', true);
            loading.show();

            try {
                // Generar ID único
                const id = 'USER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const fecha = new Date().toISOString();
                
                // Guardar en Firebase
                await db.collection('usuarios').doc(id).set({
                    id: id,
                    nombre: nombre,
                    fechaRegistro: fecha,
                    fechaActualizacion: fecha,
                    estatus: 'Pendiente'
                });
                
                // Generar QR
                generarQR(id);
                $('#nombre').val('');
                mostrarNotificacion('Usuario registrado exitosamente!', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al registrar usuario: ' + error.message, 'error');
            } finally {
                btnRegistrar.prop('disabled', false);
                loading.hide();
            }
        }

        // Generar QR
        function generarQR(userId) {
            debugger;
            const updateUrl = `${window.location.origin}${window.location.pathname.replace('registro.html', 'lista.html')}?actualizar=${userId}`;
            
            $('#qrcode').empty();
            
            try {
                const qrcode = new QRCode(document.getElementById("qrcode"), {
                    text: updateUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                $('#qrSection').show();
                window.currentQRUrl = updateUrl;
                window.currentUserId = userId;
                
            } catch (error) {
                console.error('Error generando QR:', error);
                generarQRAlternativo(updateUrl);
            }
        }

        function generarQRAlternativo(url) {
            $('#qrcode').empty();
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            const img = document.createElement('img');
            img.src = qrUrl;
            img.alt = 'Código QR';
            $('#qrcode').append(img);
            $('#qrSection').show();
        }

        function descargarQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `qr_${window.currentUserId}.png`;
                link.href = canvas.toDataURL();
                link.click();
                mostrarNotificacion('QR descargado exitosamente', 'success');
            } else {
                mostrarNotificacion('No hay QR generado para descargar', 'error');
            }
        }

        function mostrarNotificacion(mensaje, tipo) {
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                ${tipo === 'success' ? 'background: #38a169;' : 'background: #e53e3e;'}
            `;
            
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            setTimeout(() => notificacion.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notificacion.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(notificacion), 300);
            }, 3000);
        }

        // Enter key
        $(document).ready(function() {
            $('#nombre').keypress(function(e) {
                if (e.which === 13) registrarUsuario();
            });
        });
    </script>
</body>
</html>